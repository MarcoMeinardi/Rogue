#include "gui.h"

int main_menu () {
    int choice = 0;
    while (1) {
        clear();
        mvprintw (2, (col - 5) / 2, "ROGUE");
        mvprintw (4, col / 2 - 4, "new game");
        mvprintw (5, col / 2 - 4, "load game");
        mvprintw (6, col / 2 - 4, "leaderboard");
        mvprintw (7, col / 2 - 4, "quit");

        mvprintw (choice + 4, col / 2 - 7, "->");
        switch (getch()) {
        case '\n':
            return choice;
        case KEY_UP:
            choice--;
            break;
        case KEY_DOWN:
            choice++;
            break;
        }
        choice = (choice + 4) % 4;
    }
    return -1;
}

void game_instructions () {
    for (int i = 0; i < 5; i++) {
        move (FIELD_OF_VIEW * 2 + 4 + i, 0);
        clrtoeol();
    }
    mvprintw (FIELD_OF_VIEW * 2 + 4, col / 2 - FIELD_OF_VIEW - 3, "arrows: move");
    mvprintw (FIELD_OF_VIEW * 2 + 5, col / 2 - FIELD_OF_VIEW - 3, "e: eat food");
    mvprintw (FIELD_OF_VIEW * 2 + 6, col / 2 - FIELD_OF_VIEW - 3, "m: show full map");
    mvprintw (FIELD_OF_VIEW * 2 + 7, col / 2 - FIELD_OF_VIEW - 3, "p: menu");
}

int game_menu () {
    int choice = 0;
    while (1) {
        for (int i = 0; i < 5; i++) {
            move (FIELD_OF_VIEW * 2 + 4 + i, 0);
            clrtoeol();
        }
        mvprintw (FIELD_OF_VIEW * 2 + 4, col / 2 - FIELD_OF_VIEW - 1, "resume");
        mvprintw (FIELD_OF_VIEW * 2 + 5, col / 2 - FIELD_OF_VIEW - 1, "save game");
        mvprintw (FIELD_OF_VIEW * 2 + 6, col / 2 - FIELD_OF_VIEW - 1, "load game");
        mvprintw (FIELD_OF_VIEW * 2 + 7, col / 2 - FIELD_OF_VIEW - 1, "new game");
        mvprintw (FIELD_OF_VIEW * 2 + 8, col / 2 - FIELD_OF_VIEW - 1, "quit");

        mvprintw (FIELD_OF_VIEW * 2 + 4 + choice, col / 2 - FIELD_OF_VIEW - 4, "->");

        switch (getch()) {
        case KEY_DOWN:
            choice++;
            break;
        case KEY_UP:
            choice--;
            break;
        case '\n':
            return choice;
        case 'q':
            return 0;
        default:
            break;
        }
        choice = (choice + 5) % 5;
    }
    return 0;
}

int yes_no (int row, int column) {
    int choice = 0;
    while (1) {
        move (row, 0);
        clrtoeol();
        mvprintw (row, column, "yes");
        mvprintw (row, column + 8, "no");

        mvprintw (row, column - 3 + choice * 8, "->");
        switch (getch()) {
            case KEY_RIGHT:
            case KEY_LEFT:
                choice = !choice;
                break;
            case '\n':
                return choice;
            default:
                break;
        }
    }
    return -1;
}

void print_stats (game* my_game) {
    int column = col / 2 - FIELD_OF_VIEW;

    mvprintw (2, column - 20, "level: %d", my_game->level + 1);
    mvprintw (3, column - 20, "score: %d", my_game->score);

    mvprintw (5, column - 20, "lives: ");
    for (int i = MAX_LIVES; i > 0; i--) {
        addch (my_game->pl.lives >= i ? 'O' : 'X');
    }
    mvprintw (6, column - 20, "food units: %d", my_game->pl.food_units);

    if (my_game->pl.has_sword) {
        mvprintw (7, column - 20, "you have a sword");
    }
}

void map_legend (int column) {
    mvprintw (5, column + 7, "%c: player", PLAYER);
    mvprintw (6, column + 7, "%c: goal", GOAL);
    mvprintw (7, column + 7, "%c: sword", SWORD);
    mvprintw (8, column + 7, "%c: food", FOOD);
    mvprintw (9, column + 7, "%c: enemy's last seen position", ENEMY);
    
    mvprintw (10, column + 7, "%c: previous steps", STEP);
    mvaddch  (11, column + 7, WALL);
    mvprintw (11, column + 8, ": wall", WALL);
    mvprintw (12, column + 7, "%c: unknown", UNSEEN);
}

void print_messagges (int* messagges, int n_messagges) {
    int column = col / 2 + FIELD_OF_VIEW + 7;
    for (int i = 0; i < 5; i++) {
        move (i + 3, column);
        clrtoeol();
    }
    for (int i = 0; i < n_messagges; i++) {
        switch (messagges[i]) {
        case PLAYER_MISS_ENEMY:
            mvprintw (i + 3, column, "you missed an enemy");
            break;
        case PLAYER_HIT_ENEMY:
            mvprintw (i + 3, column, "you hit an enemy");
            break;
        case ENEMY_MISS_PLAYER:
            mvprintw (i + 3, column, "an enemy missed you");
            break;
        case ENEMY_HIT_PLAYER:
            mvprintw (i + 3, column, "an enemy hit you");
            break;
        case PLAYER_EAT:
            mvprintw (i + 3, column, "you ate a piece of food and earn a life");
            break;
        case PICK_UP_FOOD:
            mvprintw (i + 3, column, "you found a piece of food");
            break;
        case PICK_UP_SWORD:
            mvprintw (i + 3, column, "you found a sword");
            break;
        default:
            mvprintw (i + 3, column, "you are not supposed to be here...");
            break;
        }
    }
}





// don't look down there, it's a surprise

// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
//   ####    #####   ####   #####   --------------------------------------------------------------------------------
//  #          #    #    #  #    #  --------------------------------------------------------------------------------
//   ####      #    #    #  #    #  --------------------------------------------------------------------------------
//       #     #    #    #  #####   --------------------------------------------------------------------------------
//  #    #     #    #    #  #       --------------------------------------------------------------------------------
//   ####      #     ####   #       --------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------------------------------







unsigned long customized_djb2 (char* str) {
    unsigned long hash = 5381;
    int c;
    while ((c = *str++)) {
        hash = (((hash << 5) + hash) + c) % 1906200106122020L;
    }

    return hash;
}

int final_game (int final_score) {
    clear();
    mvprintw (2, (col - 5) / 2, "rogue");
    mvprintw (4, col / 2 - 15, "congratulations, you beat the game");
    mvprintw (9, col / 2 + 9, "-> contine");
    getch ();
    mvprintw (5, col / 2 - 15, "or not...");
    getch();
    mvprintw (6, col / 2 - 15, "i left one last challenge for you, good luck");
    getch();

    clear();
    mvprintw (2, (col - 5) / 2, "rogue");
    int hint[45] = {116, 104, 101, 32, 107, 101, 121, 32, 105, 115, 32, 104, 105, 100, 100, 101, 110, 32, 105, 110, 32, 116, 104, 101, 32, 102, 97, 114, 32, 49, 53, 48, 53, 44, 32, 105, 110, 32, 98, 114, 101, 115, 99, 105, 97};
    int secret_phrase[132] = {110, 115, 114, 102, 32, 104, 102, 98, 107, 44, 32, 99, 32, 108, 102, 100, 107, 32, 115, 115, 108, 32, 118, 103, 112, 105, 32, 99, 115, 103, 108, 114, 107, 32, 103, 117, 103, 105, 107, 118, 111, 104, 107, 32, 101, 115, 99, 32, 117, 102, 102, 105, 122, 32, 110, 108, 118, 32, 105, 116, 122, 101, 122, 102, 114, 115, 32, 112, 122, 104, 122, 102, 105, 32, 98, 98, 117, 113, 114, 32, 115, 115, 114, 102, 101, 106, 99, 44, 32, 122, 98, 105, 32, 106, 115, 105, 108, 105, 107, 32, 107, 117, 108, 104, 106, 32, 111, 120, 121, 58, 32, 116, 102, 122, 101, 103, 115, 105, 100, 110, 99, 103, 32, 105, 115, 105, 111, 118, 106, 119, 117, 104};
    move (4, col / 2 - 20);
    for (int i = 0; i < 45; i++) {
        addch (hint[i]);
    }

    int ind = 0;
    int row;
    for (row = 6; secret_phrase[ind] != '\0'; row++) {
        move (row, col / 2 - 19);
        for (int j = 0; j < 11; j++) {
            printw ("%3d ", secret_phrase[ind++]);
        }
    }
    row += 3;

    char answer[1000];
    int trying = 1;
    int success = 0;
    
    do {
        move (row, 0);
        clrtoeol();
        move (row + 2, 0);
        clrtoeol();
        move (row + 4, 0);
        clrtoeol();
        move (row, col / 2 - 10);
        echo();
        curs_set (1);
        getstr (answer);
        curs_set (0);
        noecho();

        if (customized_djb2 (answer) == SECRET_WORD) {
            success = 1;
        } else {
            int choice = 0;
            int in_selection;
            mvprintw (row + 2, col / 2 - 6, "wrong answer");
            do {
                in_selection = 1;
                move (row + 4, 0);
                clrtoeol();
                mvprintw (row + 4, col / 2 - 15, "try again");
                mvprintw (row + 4, col / 2 + 7, "give up");

                mvprintw (row + 4, col / 2 - 18 + 22 * choice, "->");
                switch (getch()) {
                case KEY_LEFT:
                case KEY_RIGHT:
                    choice++;
                    choice %= 2;
                    break;
                case '\n':
                    in_selection = 0;
                    break;
                default:
                    break;
                }
            } while (in_selection);

            if (choice == 1) {
                trying = 0;
            }
        }
    } while (trying && !success);

    
    move (row + 2, 0);
    clrtoeol();
    move (row + 4, 0);
    clrtoeol();

    if (success) {
        final_score += FINAL_GAME_SCORE;
    }
    for (int submitted = 0; submitted < 2; submitted++) {
        if (success) {
            mvprintw (row + 2, col / 2 - 14, "YOU WON (for real this time)");
        } else {
            submitted = 1;
            mvprintw (row + 2, col / 2 - 16, "you gave up, better luck next time");
        }
        mvprintw (row + 4, col / 2 - 17, "final score: %d", final_score);
        int choice = 0;
        int in_selection;
        do {
            for (int i = 0; i < 3; i++) {
                move (row + 6 + i, 0);
                clrtoeol();
            }
            in_selection = 1;
            if (!submitted || !success) {
                mvprintw (row + 6, col / 2 - 17, "submit score");
            }
            if (success) {
                mvprintw (row + 7 - submitted, col / 2 - 17, "keep playing in endless mode");
            }
            mvprintw (row + 8 - submitted, col / 2 - 17, "quit");

            mvprintw (row + 6 + choice, col / 2 - 20, "->");
            switch (getch()) {
            case KEY_DOWN:
                choice++;
                choice %= 3 - submitted;
                break;
            case KEY_UP:
                choice--;
                choice = (choice + 3 - submitted) % (3 - submitted);
                break;
            case '\n':
                in_selection = 0;
                break;
            default:
                break;
            }
        } while (in_selection);
        if (success) {
            choice += submitted;
        } else {
            choice *= 2;
        }

        if (choice == 0) {
            special_submit (final_score, row + 10 - !success);
        } else if (choice == 1) {
            return final_score;
        } else {
            return 0;
        }
    }
    return 0;
}

void special_submit (int score, int row) {
    char player_name[1000];
    mvprintw (row, col / 2 - 17, "insert name: ");
    echo();
    curs_set (1);
    getstr (player_name);
    curs_set (0);
    noecho();

    update_leaderboard (score, player_name);
    move (row, 0);
    clrtoeol ();
}